<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InterMediate Assignment</title>
</head>
<>

<svg width="960" height="720" id="bubbleGraph"></svg>

<ul id="mostplayedlist">

</ul>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

    var savedData;
    var packWidth = 960;
    var packHeight = 720;

    var bubbleGraph = d3.select("#bubbleGraph").attr("width", packWidth).attr("height", packHeight);

    var bubbleScale = d3.scaleLinear().range([0, 10]);

    var bpmScale = d3.scaleLinear().range([0, 200]).domain([0, 100]);

    d3.csv("top40.csv", function (error, data) {

        savedData = data;

        bubbleScale.domain(
            [0, d3.max(data, function (d) {
                return d["dj_play_count"]
            })]
        );

        //sort the data.
        data.sort(function (a, b) {
            return (+b.dj_play_count - +a.dj_play_count);
        });

        makeList(data);

        createBubbles(data, 200, '2013');
    });

    function refreshData() {
        d3.csv("top40.csv", function (error, data) {
            if (error) { return;}
            savedData = data;
            return data;
        });
    }

    function changeBpm() {
        var currentBpm = d3.select("#bpmSlider").property("value");
        console.log(bpmScale(currentBpm));
        console.log(savedData);

        //redrawBubbles
        createBubbles(savedData, bpmScale(currentBpm));
    }

    function makeList(data) {
        var list = d3.select("#mostplayedlist").selectAll(".listItem").data(data);

        list.enter().append("li")
            .attr("class", "listItem")
            .text(function (d) {
                    return d.title + " played this many times: " + d.dj_play_count;
                }
            );
        list.exit().remove();
    }

    function createBubbles(data, maxBpm, year) {

        var newData = {name: "root", children: data};

        var hierarchy = d3.hierarchy(newData).sum(function (d) {return d.dj_play_count;});

        console.log(hierarchy);

        var pack = d3.pack().size([packWidth, packHeight]);

        pack(hierarchy);

        console.log()

        var t = d3.transition().duration(5000).ease(d3.easeLinear);

        var bubbles = d3.select("#bubbleGraph").selectAll(".bubble").data(hierarchy.leaves())
            .enter()
            .filter(function (d) {return d.data.year === year; })
            .append("circle")

            .attr("cy", function (d) {
                return d.y;
            })
            .attr("cx", function (d) {
                return d.x;
            })
            .attr("class", "bubble")
            .transition(t)
            .attr("r", function (d) {
                return d.r;
            })
            .append("svg:title").text(function (d) {return d.data.title;});

        bubbles.exit().remove();
    }

</script>


</body>
</html>